/**
 * Expo Config Plugin - Auto-configures Android SDK location
 * This is the proper Expo way to handle Android SDK detection
 * Runs automatically during expo prebuild
 */

const { withDangerousMod } = require('@expo/config-plugins');
const fs = require('fs');
const path = require('path');
const os = require('os');

function findAndroidSdk() {
  // 1. Check ANDROID_HOME
  if (process.env.ANDROID_HOME && fs.existsSync(process.env.ANDROID_HOME)) {
    return process.env.ANDROID_HOME;
  }
  
  // 2. Check ANDROID_SDK_ROOT
  if (process.env.ANDROID_SDK_ROOT && fs.existsSync(process.env.ANDROID_SDK_ROOT)) {
    return process.env.ANDROID_SDK_ROOT;
  }
  
  // 3. Check common Windows locations
  const homeDir = os.homedir();
  const commonPaths = [
    path.join(homeDir, 'AppData', 'Local', 'Android', 'Sdk'),
    path.join(process.env.LOCALAPPDATA || '', 'Android', 'Sdk'),
    path.join(process.env.PROGRAMFILES || '', 'Android', 'android-sdk'),
    'C:\\Android\\Sdk',
  ];
  
  for (const testPath of commonPaths) {
    if (testPath && fs.existsSync(testPath)) {
      return testPath;
    }
  }
  
  return null;
}

const withAndroidSdk = (config) => {
  return withDangerousMod(config, [
    'android',
    async (config) => {
      const sdkPath = findAndroidSdk();
      
      if (sdkPath) {
        // Normalize path for Windows
        const normalizedPath = sdkPath.replace(/\\/g, '/');
        
        // Ensure android directory exists
        const androidDir = config.modRequest.platformProjectRoot;
        if (!fs.existsSync(androidDir)) {
          fs.mkdirSync(androidDir, { recursive: true });
        }
        
        // Create local.properties
        const localPropertiesPath = path.join(androidDir, 'local.properties');
        const content = `## This file is automatically generated by Expo config plugin.
# Do not modify this file -- YOUR CHANGES WILL BE ERASED!
#
# This file should *NOT* be checked into Version Control Systems,
# as it contains information specific to your local configuration.
#
# Location of the SDK. This is only used by Gradle.
sdk.dir=${normalizedPath}
`;
        
        fs.writeFileSync(localPropertiesPath, content, 'utf8');
      }
      
      return config;
    },
  ]);
};

module.exports = withAndroidSdk;

